# Skript システム修正指示まとめ（OOM / kill 対策）

## 背景

* サーバーが `Killed` で突然停止する問題が発生
* 原因は Java の OOM 例外ではなく **Linux OOM Killer**
* 実メモリ 11GB に対し `-Xmx10G` ＋ Skript 常時処理により
  メモリスパイクが発生している

---

## 結論（重要）

機能要件（DB操作・村人NPC操作）は妥当だが、
**実装が「常時同期・全体ループ型」になっており、Skriptでは危険**。

以下の変更が必須。

---

## 共通設計方針（最重要）

### ❌ 禁止

* `every tick`
* `every 1 second` + `loop all players`
* DB内容の定期ポーリング
* Entity / Player / DB結果を list 変数に常駐保持
* ログアウト後も残る `{player::*}` 系変数

### ✅ 原則

* **イベント駆動のみ**
* **必要な時だけ DB / NPC / sidebar を触る**
* **変数には寿命を持たせる**

---

## Java 起動オプション（必須変更）

### 変更前

```
-Xms8G -Xmx10G
```

### 変更後（11GBサーバー想定）

```
-Xms4G -Xmx6G
```

---

## ファイル別 修正指示

### 1. player-data-sync.sk（最優先）

#### 問題点

* プレイヤーデータを常時同期している可能性
* DB結果を変数に保持し続けている
* ログアウト時に解放されていない

#### 修正指示

* DBアクセスは以下のみで実行

  * on join
  * 通貨変動時
  * 明示的な保存処理
* ログアウト時に必ず削除

```
on quit:
  delete {playerdata::%uuid of player%::*}
```

* サーバー起動時に全削除

```
on load:
  delete {playerdata::*}
```

---

### 2. sidebar.sk

#### 問題点

* 定期更新（every X seconds）で全文再生成している可能性
* プレイヤー全体ループが負荷・メモリ双方に悪影響

#### 修正指示

* 更新トリガーをイベントに限定

  * join
  * quit
  * お金が変わった時
* 定期更新が必要な場合も **5〜10秒以上**

❌ NG例

```
every 1 second:
  loop all players:
    update sidebar
```

---

### 3. npc-system.sk

#### 問題点

* 村人 / Entity を変数で保持している可能性
* 再生成時に古い参照が残る危険

#### 修正指示

* NBT / 内部データ設定は **生成時のみ**
* 毎tickでの監視・再設定は禁止
* 識別は metadata / persistent data で行う

---

### 4. database-operation.sk / load-database.sk

#### 問題点

* 起動時にテーブル全件ロードの可能性
* DB結果を list 変数に展開している可能性

#### 修正指示

* 起動時に全件ロードしない
* 必要な行のみ SELECT
* 使用後は変数を削除

---

### 5. debug-*.sk（本番では無効化）

対象：

* debug-db.sk
* debug-parse.sk
* debug-ticket.sk

#### 修正指示

* 本番環境では無効化
* ログ・履歴・解析結果を変数に残さない

---

## 変数管理ルール（必須）

* `{player::*}` `{uuid::*}` `{data::*}` 系は必ず delete する
* 一時データは「一時変数」と明示
* reload / 再起動時に重複ロードしない設計にする

---

## なぜこれが必要か（技術的理由）

* Skript は GC に弱く、オブジェクト再生成に不向き
* sidebar / NPC / DB を常時処理するとヒープ断片化が起きる
* Java が OS メモリを超えた瞬間、Linux がプロセスを kill する

→ **OutOfMemoryError は出ず、`Killed` だけが表示される**

---

## 最終目標

* 機能は維持
* 処理はイベント駆動
* 常駐メモリを増やさない
* OOM Killer を発動させない

---

## 優先度まとめ

1. Java メモリ設定変更
2. player-data-sync.sk の変数寿命修正
3. sidebar 更新頻度の削減
4. debug 系の無効化
5. NPC / DB の常時処理排除
